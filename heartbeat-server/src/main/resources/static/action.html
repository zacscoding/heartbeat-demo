<!DOCTYPE html>
<html>
<head>
  <title>Action with Websocket</title>
  <link href="/webjars/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="/main.css" rel="stylesheet">
  <script src="/webjars/jquery/jquery.min.js"></script>
  <script src="/webjars/sockjs-client/sockjs.min.js"></script>
  <script src="/webjars/stomp-websocket/stomp.min.js"></script>
  <script src="/action.js"></script>
</head>
<body>
<noscript><h2 style="color: #ff0000">Seems your browser doesn't support Javascript! Websocket relies on Javascript being
  enabled. Please enable
  Javascript and reload this page!</h2></noscript>

<div id="main-content">
  <div class="row">
    <div class="col-md-12">
      <div class="col-md-2">
        <label for="agent">Agent Name</label>
      </div>
      <div class="col-md-4">
        <select class="form-control" id="agent"></select>
      </div>
      <div class="col-md-2">
        <label for="serviceName">Service Name</label>
      </div>
      <div class="col-md-4">
        <input type="text" id="serviceName" class="form-control">
      </div>
    </div>
  </div>
  <div class="row" style="padding-top : 10px;">
    <div class="col-md-12">
      <div class="col-md-2">
        <label for="actionType">Action Type</label>
      </div>
      <div class="col-md-4">
        <select class="form-control" id="actionType">
          <option value="START">START</option>
          <option value="START">STOP</option>
          <option value="START">RESTART</option>
        </select>
      </div>
      <div class="col-md-2">
        <button id="btnAction" class="btn btn-default">Request</button>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-12">
      <table id="conversation" class="table table-striped">
        <thead>
        <tr>
          <th>Action result</th>
        </tr>
        </thead>
        <tbody id="action-results">
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  var existAgent = false;

  function getAgents() {
    $.ajax({
      url    : 'agents',
      success: function (agents) {
        console.log('> success to get agents\n', agents);
        var html = '';
        if (agents) {
          existAgent = true;
          for (var i = 0, size = agents.length; i < size; i++) {
            var agentName = agents[i].agentName;
            html += '<option value="' + agentName + '">' + agentName + '</option>';
          }
        } else {
          html = '<option>No Agents</option>';
        }

        var $target = $('#agent');
        $target.empty();
        $target.append(html);
      },
      error  : function (jqxhr) {
        console.log('> failed to get agents\n', jqxhr);
      }
    });
  }

  var stompClient = null;

  function requestAction(agentName, serviceName, actionType) {
    if (!isConnected()) {
      console.log('try to connect..');
      var socket = new SockJS('/heartbeat-websocket');
      stompClient = Stomp.over(socket);
      stompClient.connect({}, function (frame) {
        console.log('Connected: ' + frame);
        stompClient.send('/app/action/' + agentName + '/' + serviceName + '/' + actionType, {}, JSON.stringify({}));
        var subscribe = stompClient.subscribe('/result/action/' + agentName + '/' + serviceName + '/' + actionType, function (result) {
          console.log('> receive message : ', result);
        });
      });
    } else {
      console.log('already connected');
      stompClient.send('/app/action/' + agentName + '/' + serviceName + '/' + actionType, {}, JSON.stringify({}));
      var subscribe = stompClient.subscribe('/result/action/' + agentName + '/' + serviceName + '/' + actionType, function (result) {
        console.log('> receive message : ', result);
      });
    }
  }

  function isConnected() {
    console.log('check stompClient..', stompClient);
    if (typeof stompClient === 'undefined' || !stompClient) {
      return false;
    }

    return stompClient.connected;
  }

  $(function () {
    (function initialize() {
      getAgents();
    })();

    $('#btnAction').click(function () {
      var agentName = $('#agent option:selected').val();
      var serviceName = $('#serviceName').val();
      var actionType = $('#actionType option:selected').val();
      if (!serviceName) {
        alert('Service name is empty');
        $('#serviceName').focus();
        return;
      }

      requestAction(agentName, serviceName, actionType);
    });
  });

</script>
</body>
</html>